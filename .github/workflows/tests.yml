name: Comprehensive Test Suite

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_VERSION: '1.90.0'
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.3'

jobs:
  # Rust unit tests
  rust-unit-tests:
    name: Rust Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Run Rust unit tests
        working-directory: apps/desktop/src-tauri
        run: cargo test --lib --bins --all-features -- --nocapture

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-unit-test-results
          path: apps/desktop/src-tauri/target/debug/test-results/

  # Rust integration tests
  rust-integration-tests:
    name: Rust Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Run integration tests
        working-directory: apps/desktop/src-tauri
        run: cargo test --test '*' --all-features -- --test-threads=1

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-integration-test-results
          path: apps/desktop/src-tauri/target/debug/test-results/

  # Security tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Run security tests
        working-directory: apps/desktop/src-tauri
        run: |
          cargo test security:: -- --nocapture

      - name: Run cargo audit
        run: |
          cargo install cargo-audit
          cargo audit

      - name: Upload security test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: apps/desktop/src-tauri/target/debug/test-results/

  # Frontend unit tests
  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm --filter @agiworkforce/desktop test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-test-results
          path: apps/desktop/coverage/

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: apps/desktop/coverage/coverage-final.json
          flags: frontend-unit

  # E2E tests
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm --filter @agiworkforce/desktop exec playwright install --with-deps chromium

      - name: Build desktop app
        run: pnpm --filter @agiworkforce/desktop build

      - name: Run E2E tests
        run: pnpm --filter @agiworkforce/desktop test:e2e

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: apps/desktop/playwright-report/

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots
          path: apps/desktop/test-results/

  # Performance benchmarks
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Run benchmarks
        working-directory: apps/desktop/src-tauri
        run: cargo bench --bench agi_benchmarks --bench automation_benchmarks

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: apps/desktop/src-tauri/target/criterion/

  # Code coverage
  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Generate coverage
        working-directory: apps/desktop/src-tauri
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: apps/desktop/src-tauri/lcov.info
          flags: rust

      - name: Check coverage threshold
        working-directory: apps/desktop/src-tauri
        run: |
          cargo llvm-cov --all-features --workspace --summary-only | \
          grep -oP 'TOTAL.*\K\d+\.\d+' | \
          awk '{if ($1 < 70) exit 1}'

  # Test result summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - rust-unit-tests
      - rust-integration-tests
      - security-tests
      - frontend-unit-tests
      - e2e-tests
      - performance-benchmarks
      - code-coverage
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Test Suite Results:"
          echo "==================="
          echo "Rust Unit Tests: ${{ needs.rust-unit-tests.result }}"
          echo "Rust Integration Tests: ${{ needs.rust-integration-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Frontend Unit Tests: ${{ needs.frontend-unit-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "Performance Benchmarks: ${{ needs.performance-benchmarks.result }}"
          echo "Code Coverage: ${{ needs.code-coverage.result }}"

      - name: Fail if any test failed
        if: |
          needs.rust-unit-tests.result == 'failure' ||
          needs.rust-integration-tests.result == 'failure' ||
          needs.security-tests.result == 'failure' ||
          needs.frontend-unit-tests.result == 'failure' ||
          needs.e2e-tests.result == 'failure'
        run: exit 1
